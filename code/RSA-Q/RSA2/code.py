import binascii

# 题目给出的参数
e = 65537
n = 248254007851526241177721526698901802985832766176221609612258877371620580060433101538328030305219918697643619814200930679612109885533801335348445023751670478437073055544724280684733298051599167660303645183146161497485358633681492129668802402065797789905550489547645118787266601929429724133167768465309665906113
dp = 905074498052346904643025132879518330691925174573054004621877253318682675055421970943552016695528560364834446303196939207056642927148093290374440210503657
c = 140423670976252696807533673586209400575664282100684119784203527124521188996403826597436883766041879067494280957410201958935737360380801845453829293997433414188838725751796261702622028587211560353362847191060306578510511380965162133472698713063592621028959167072781482562673683090590521214218071160287665180751

def solve_rsa():
    print("[*] 正在尝试通过 dp 恢复 p ...")
    
    p = 0
    # 遍历 k，范围是 1 到 e
    for k in range(1, e):
        # 检查整除性：(e * dp - 1) 必须能被 k 整除
        if (e * dp - 1) % k == 0:
            # 计算候选 p
            candidate_p = (e * dp - 1) // k + 1
            
            # 验证 candidate_p 是否是 n 的因子
            if n % candidate_p == 0:
                p = candidate_p
                print(f"[+] 找到 k = {k}")
                print(f"[+] 找到 p = {p}")
                break
    
    if p == 0:
        print("[-] 未找到 p，可能 dp 或 n 有误。")
        return

    # 计算 q
    q = n // p
    print(f"[+] 计算出 q = {q}")

    # 常规 RSA 解密步骤
    phi = (p - 1) * (q - 1)
    
    # 计算 d (e 关于 phi 的模逆)
    d = pow(e, -1, phi)
    
    # 解密明文 m
    m = pow(c, d, n)
    
    # 将整数转为字符串
    try:
        flag_hex = hex(m)[2:]
        if len(flag_hex) % 2 != 0:
            flag_hex = '0' + flag_hex
        flag = bytes.fromhex(flag_hex).decode('utf-8') # 尝试 utf-8 解码
        print("--------------------------------------------------")
        print(f"Flag: {flag}")
        print("--------------------------------------------------")
    except Exception as ex:
        print(f"解码失败，明文整数为: {m}")
        print(f"错误: {ex}")

if __name__ == "__main__":
    solve_rsa()